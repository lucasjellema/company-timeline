<!-- Add Event Modal -->
<div id="add-event-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add New Event</h2>
            <button id="close-modal-btn" class="btn-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <form id="add-event-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="event-title">Title</label>
                        <input type="text" id="event-title" required>
                    </div>
                    <div class="form-group">
                        <label for="event-type">Type</label>
                        <div class="input-with-datalist">
                            <input type="text" id="event-type" list="type-options" required autocomplete="off"
                                placeholder="Select or type capability...">
                            <datalist id="type-options"></datalist>
                        </div>
                    </div>
                </div>



                <div class="form-grid">
                    <div class="form-group">
                        <label for="event-l0">Level 0 (Company/Dept)</label>
                        <div class="input-with-datalist">
                            <input type="text" id="event-l0" list="l0-options" required autocomplete="off">
                            <datalist id="l0-options"></datalist>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="event-l1">Level 1 (Optional)</label>
                        <div class="input-with-datalist">
                            <input type="text" id="event-l1" list="l1-options" autocomplete="off">
                            <datalist id="l1-options"></datalist>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="event-l2">Level 2 (Optional)</label>
                        <div class="input-with-datalist">
                            <input type="text" id="event-l2" list="l2-options" autocomplete="off">
                            <datalist id="l2-options"></datalist>
                        </div>
                    </div>
                </div>

                <div class="form-grid" style="grid-template-columns: 1fr auto 1fr; align-items: end; gap: 0.5rem;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="event-start">Start Date (YYYY-MM[-DD])</label>
                        <input type="text" id="event-start" placeholder="2023-01 or 2023-01-15" required>
                    </div>
                    <div style="padding-bottom: 4px;">
                        <button type="button" id="copy-date-btn" class="btn-icon" title="Copy Start Date to End Date"
                            style="width: 36px; height: 38px; border-radius: 4px; background: rgba(255,255,255,0.05);">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M5 12h14"></path>
                                <path d="M12 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="event-end">End Date (Optional)</label>
                        <input type="text" id="event-end" placeholder="2023-06 (Empty for point event)">
                    </div>
                </div>

                <div class="form-grid" style="grid-template-columns: 2fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="event-desc">Description</label>
                        <textarea id="event-desc" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Appearance (Optional Override)</label>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <div id="event-icon-wrapper" class="custom-select" style="width: 100%;">
                                <div class="select-selected">
                                    <span>No Icon</span>
                                </div>
                                <div class="select-items select-hide">
                                    <!-- Populated via JS -->
                                </div>
                            </div>
                            <input type="hidden" id="event-icon">

                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="color" id="event-color" style="width: 40px; height: 38px; padding: 2px;">
                                <button type="button" id="clear-color-btn" class="btn-icon" title="Clear Color"
                                    style="height: 38px;">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>



                <div class="form-group">
                    <label>Image</label>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <input type="url" id="event-image" placeholder="Image URL (https://...)"
                            style="margin-bottom: 4px;">

                        <div class="flex-row" style="gap: 0.5rem; align-items: center;">
                            <label for="event-image-file" class="btn btn-secondary btn-sm"
                                style="cursor: pointer; display: inline-flex; align-items: center; gap: 4px;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                    <polyline points="17 8 12 3 7 8" />
                                    <line x1="12" y1="3" x2="12" y2="15" />
                                </svg>
                                Upload File
                            </label>
                            <input type="file" id="event-image-file" accept="image/*" hidden>
                            <span id="file-name-display"
                                style="font-size: 0.8rem; color: var(--text-muted); font-style: italic;"></span>
                        </div>

                        <div id="paste-image-area" tabindex="0"
                            style="border: 2px dashed var(--border); padding: 1rem; text-align: center; border-radius: 4px; color: var(--text-muted); cursor: pointer; outline: none; transition: all 0.2s;"
                            onfocus="this.style.borderColor = 'var(--primary)'; this.style.backgroundColor = 'rgba(255, 255, 255, 0.05)';"
                            onblur="this.style.borderColor = 'var(--border)'; this.style.backgroundColor = 'transparent';">
                            <span style="pointer-events: none;">Click here and Press Ctrl+V to paste image</span>
                        </div>

                        <input type="hidden" id="event-image-local-id">

                        <div id="event-image-preview-container" class="hidden"
                            style="margin-top: 0.5rem; position: relative; width: fit-content;">
                            <img id="event-image-preview" src="" alt="Preview"
                                style="max-height: 200px; max-width: 100%; border-radius: 4px; border: 1px solid var(--border); display: block;">
                            <button type="button" id="clear-image-btn" class="btn-icon" title="Remove Image"
                                style="position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.6); color: white; border-radius: 50%; width: 24px; height: 24px; padding: 4px;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Location (Click map to set)</label>
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <input type="text" id="geo-search-input" placeholder="Search location (e.g. City, Address)..."
                            style="flex-grow: 1;">
                        <button type="button" id="geo-search-btn" class="btn btn-secondary">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                        </button>
                    </div>
                    <div id="geo-search-results" class="hidden"
                        style="margin-bottom: 0.5rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; max-height: 200px; overflow-y: auto;">
                        <!-- Results populated by JS -->
                    </div>
                    <div id="modal-map" class="modal-map-container"></div>
                    <input type="hidden" id="event-lat">
                    <input type="hidden" id="event-lng">
                    <input type="text" id="event-location-name" class="form-control" placeholder="Location Name"
                        style="margin-top: 8px;">

                    <!-- Predefined Location Selector -->
                    <div id="named-location-container" class="hidden" style="margin-top: 8px; position: relative;">
                        <input type="text" id="named-location-search" class="form-control"
                            placeholder="Search saved locations..."
                            style="font-size: 0.9rem; border-color: var(--primary);">
                        <div id="named-location-results" class="hidden"
                            style="position: absolute; width: 100%; max-height: 150px; overflow-y: auto; background: var(--bg-card); border: 1px solid var(--border); border-top: none; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        </div>
                    </div>

                    <div id="map-coords-display" class="map-hint">No location selected</div>
                </div>

                <div class="form-actions">
                    <button type="button" id="cancel-event-btn" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Event</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create Story Modal -->
<div id="create-story-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Create New Story</h2>
            <button id="close-story-modal-btn" class="btn-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <form id="create-story-form">
                <div class="form-group">
                    <label for="story-title-input">Story Title</label>
                    <input type="text" id="story-title-input" required placeholder="e.g. Q1 Roadmap">
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="story-start">Start Date (Year or ISO)</label>
                        <input type="text" id="story-start" required placeholder="YYYY or YYYY-MM">
                    </div>
                    <div class="form-group">
                        <label for="story-end">End Date (Year or ISO)</label>
                        <input type="text" id="story-end" required placeholder="YYYY or YYYY-MM">
                    </div>
                </div>
                <div class="form-group">
                    <label for="story-desc">Description</label>
                    <textarea id="story-desc" rows="3" placeholder="Brief description of this story..."></textarea>
                </div>
                <div class="form-group">
                    <label for="story-csv-paste">Initial Data (CSV Paste)</label>
                    <textarea id="story-csv-paste" rows="3"
                        placeholder="Paste CSV content here to pre-populate the story..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" id="cancel-story-btn" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Story</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div id="story-settings-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Story Settings</h2>
            <button id="close-settings-btn" class="btn-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <form id="story-settings-form">
                <div class="form-group">
                    <label for="settings-title">Story Name</label>
                    <input type="text" id="settings-title" required>
                </div>
                <div class="form-group">
                    <label for="settings-desc">Description</label>
                    <textarea id="settings-desc" rows="3"></textarea>
                </div>

                <div class="form-group collapsible-section" id="settings-colors-collapsible"
                    style="border: 1px solid var(--border); border-radius: 6px; padding: 0.5rem; margin-bottom: 1rem;">
                    <div class="collapsible-header"
                        style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                        <label style="cursor: pointer; margin-bottom: 0; font-weight: 500;">Event Type
                            Colors</label>
                        <svg class="chevron-icon" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" style="transition: transform 0.2s;">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </div>
                    <div class="collapsible-content" style="padding-top: 1rem;">
                        <div id="color-settings-container" class="color-grid">
                            <!-- Dynamic color pickers will go here -->
                        </div>
                    </div>
                </div>

                <div class="form-group collapsible-section collapsed" id="settings-locations-collapsible"
                    style="border: 1px solid var(--border); border-radius: 6px; padding: 0.5rem; margin-bottom: 1rem;">
                    <div class="collapsible-header"
                        style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                        <label style="cursor: pointer; margin-bottom: 0; font-weight: 500;">Predefined Named
                            Locations</label>
                        <svg class="chevron-icon" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" style="transition: transform 0.2s;">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </div>
                    <div class="collapsible-content" style="padding-top: 1rem;">
                        <div id="settings-locations-container">
                            <div class="form-group" style="margin-bottom: 0.5rem;">
                                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <input type="text" id="settings-loc-search"
                                        placeholder="Search location (e.g. City, Address)..." style="flex-grow: 1;">
                                    <button type="button" id="settings-loc-search-btn" class="btn btn-secondary">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2">
                                            <circle cx="11" cy="11" r="8"></circle>
                                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                        </svg>
                                    </button>
                                </div>
                                <div id="settings-loc-search-results" class="hidden"
                                    style="margin-bottom: 0.5rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; max-height: 200px; overflow-y: auto;">
                                </div>

                                <div id="settings-map" class="modal-map-container"
                                    style="height: 200px; margin-bottom: 0.5rem;"></div>
                                <input type="hidden" id="settings-loc-lat">
                                <input type="hidden" id="settings-loc-lng">
                                <input type="hidden" id="settings-loc-id"> <!-- For editing -->

                                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <input type="text" id="settings-loc-name" class="form-control"
                                        placeholder="Location Name" style="flex: 1;">
                                </div>
                                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <textarea id="settings-loc-desc" class="form-control" rows="2"
                                        placeholder="Description (Optional)" style="flex: 1;"></textarea>
                                    <button type="button" id="settings-loc-add-btn" class="btn btn-primary"
                                        title="Add/Update Location" style="align-self: flex-start;">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="settings-divider"
                                style="height: 1rem; border-bottom: 1px solid var(--border); margin-bottom: 1rem;">
                            </div>

                            <div class="locations-list-container">
                                <div
                                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <div>
                                        <label style="margin-bottom: 0; display: inline-block;">Predefined
                                            Locations</label>
                                        <a href="#" id="settings-loc-show-all"
                                            style="font-size: 0.8rem; margin-left: 0.5rem; text-decoration: none;">(Show
                                            All)</a>
                                    </div>
                                    <input type="text" id="settings-loc-filter" placeholder="Filter..."
                                        class="form-control"
                                        style="width: 120px; font-size: 0.8rem; padding: 2px 6px; height: auto;">
                                </div>
                                <div id="settings-locations-list"
                                    style="max-height: 200px; overflow-y: auto; background: var(--bg-input); border: 1px solid var(--border); border-radius: 4px;">
                                    <!-- Populated via JS -->
                                    <div class="empty-state"
                                        style="padding: 1rem; text-align: center; color: var(--text-muted); font-size: 0.9rem;">
                                        No locations defined.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="settings-csv-paste">Import Data (CSV Paste)</label>
                    <textarea id="settings-csv-paste" rows="3"
                        placeholder="Paste CSV content here to append events to this story..."></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" id="cancel-settings-btn" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Settings</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Load Story Modal -->
<div id="load-story-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Load Story</h2>
            <button id="close-load-modal-btn" class="btn-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div style="margin-bottom: 1rem; display: flex; justify-content: flex-end;">
                <button id="browse-shipped-btn" class="btn btn-secondary btn-sm">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        style="margin-right: 4px;">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                    </svg>
                    Browse Shipped Stories
                </button>
            </div>
            <ul id="story-list-container" class="story-list">
                <!-- Stories will be populated here -->
            </ul>
        </div>
    </div>
</div>

<!-- Shipped Stories Modal -->
<div id="shipped-stories-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Shipped Stories</h2>
            <button id="close-shipped-modal-btn" class="btn-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">Select a pre-packaged story to import and
                load.</p>
            <ul id="shipped-story-list" class="story-list">
                <!-- Shipped stories will be populated here -->
            </ul>
        </div>
    </div>
</div>

<!-- Full Map Modal -->
<div id="full-map-modal" class="modal-overlay hidden">
    <div class="modal-content"
        style="width: 95vw; height: 90vh; max-width: none; max-height: none; display: flex; flex-direction: column;">
        <div class="modal-header">
            <h2>Full Map View</h2>
            <button id="close-map-modal-btn" class="btn-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div id="full-map-modal-body" class="modal-body"
            style="padding: 0; flex-grow: 1; position: relative; background: var(--bg-map-container);">
            <!-- Map will be moved here -->
        </div>
    </div>
</div>

<!-- Map Label Settings Modal -->
<div id="map-label-settings-modal" class="modal-overlay hidden">
    <div class="modal-content" style="max-width: 300px;">
        <div class="modal-header">
            <h3>Label Content</h3>
            <button id="close-map-label-settings-btn" class="btn-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group checkbox-row">
                <input type="checkbox" id="label-show-location">
                <label for="label-show-location">Location Name</label>
            </div>
            <div class="form-group checkbox-row">
                <input type="checkbox" id="label-show-title" checked>
                <label for="label-show-title">Event Title</label>
            </div>
            <div class="form-group checkbox-row">
                <input type="checkbox" id="label-show-l0">
                <label for="label-show-l0">Level 0 (Company/Dept)</label>
            </div>
            <div class="form-group checkbox-row">
                <input type="checkbox" id="label-show-l1">
                <label for="label-show-l1">Level 1 (Project/Stream)</label>
            </div>
            <div class="form-group checkbox-row">
                <input type="checkbox" id="label-show-start" checked>
                <label for="label-show-start">Start Date</label>
            </div>
            <div class="form-group checkbox-row">
                <input type="checkbox" id="label-show-end" checked>
                <label for="label-show-end">End Date</label>
            </div>
            <div class="form-actions">
                <button id="save-map-label-settings-btn" class="btn btn-primary btn-block">Apply</button>
            </div>
        </div>
    </div>
</div>